<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sounds Sus üé≠ Ultra Alpha Multiplayer</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body {
    background:#121212;
    color:#fff;
    font-family:Arial;
    text-align:center;
    transition:background 0.5s, color 0.5s;
  }
  input, button, textarea {
    margin:6px; padding:8px; border-radius:8px; border:none;
  }
  button {
    background:#1e88e5; color:white; cursor:pointer; font-weight:bold; transition: all 0.2s;
  }
  button:hover { background:#1565c0; transform:scale(1.05);}
  .save-list { margin:10px auto; width:300px; background:#222; border-radius:8px; padding:10px; }
  .save-item { cursor:pointer; margin:4px; padding:6px; background:#333; border-radius:6px; transition: all 0.2s;}
  .save-item:hover { background:#444; transform:scale(1.02);}
  #game, #menu, #questionScreen { display:block; }
  .card-container { perspective: 1000px; display: inline-block; margin: 20px auto 60px auto; }
  .card { background: #111; border-radius: 12px; padding: 12px; min-width: 250px; min-height: 150px; transform-style: preserve-3d; transition: transform 0.8s; margin:auto; z-index:1;}
  .card .front, .card .back { position:absolute; width:100%; height:100%; backface-visibility:hidden; display:flex; flex-direction:column; align-items:center; justify-content:center; border-radius:12px; }
  .card .back { background:#222; color:#fff; transform:rotateY(0deg); font-size:1.2em;}
  .card .front { transform:rotateY(180deg); background:#333; color:#fff; font-size:1em; padding:10px;}
  .card.flipped { transform:rotateY(-180deg);}
  .history { background:#222; padding:8px; border-radius:8px; margin-top:10px; max-height:200px; overflow-y:auto; text-align:left; }
  .history-entry { border-bottom:1px solid #333; padding:4px; }
</style>
</head>
<body>
<h1>Sounds Sus üé≠ <span id="themeName">(Default)</span></h1>

<div id="menu">
  <h2>Join or Create Room</h2>
  <input id="nameInput" placeholder="Enter your name">
  <input id="roomInput" placeholder="Room code (leave blank to create new)">
  <button id="joinBtn">Join Room</button>

  <h3>Saved Games</h3>
  <div class="save-list" id="saveList"></div>
</div>

<div id="game" style="display:none;">
  <h2 id="turnInfo"></h2>

  <div id="cardSetup">
    <textarea id="questionInput" placeholder="Enter question"></textarea><br>
    <textarea id="answerInput" placeholder="Enter correct answer"></textarea><br>
    <textarea id="fake1" placeholder="Fake answer 1"></textarea><br>
    <textarea id="fake2" placeholder="Fake answer 2"></textarea><br>
    <button onclick="prepareCard()">Confirm Card</button>
    <button onclick="drawRandomCard()">üé≤ Draw Random Card</button>
  </div>

  <div id="questionScreen" class="card-container">
    <div class="card" id="cardFrontBack">
      <div class="front">
        <h3 id="questionText"></h3>
        <div id="options"></div>
      </div>
      <div class="back">
        <h3>üÇ† Card</h3>
        <p>Turn to reveal the question!</p>
      </div>
    </div>
  </div>

  <h3>Scores</h3>
  <div id="scores"></div>

  <h3>Round History</h3>
  <div class="history" id="history"></div>

  <br>
  <button onclick="returnToMenu()">üè† Return to Menu</button>
</div>

<script>
const socket = io();

// ---------- Multiplayer room setup ----------
let roomId = null;
let playerName = null;
let gameData = { players: [], scores:{}, turnIndex:0, state:"setup", currentCard:null, history:[], guesserQueue:null, currentGuesserIndex:null, theme:"classic" };

// Auto-fill name
const savedName = localStorage.getItem("playerName");
if(savedName) document.getElementById("nameInput").value = savedName;

document.getElementById("joinBtn").onclick = () => {
  playerName = document.getElementById("nameInput").value.trim() || "Player-" + Math.floor(Math.random()*1000);
  roomId = document.getElementById("roomInput").value.trim().toUpperCase() || null;
  localStorage.setItem("playerName", playerName);
  socket.emit("joinGame",{roomId, playerName});
};

socket.on("roomJoined",(r)=>{
  roomId = r;
  document.getElementById("menu").style.display="none";
  document.getElementById("game").style.display="block";
  document.getElementById("roomInput").value = roomId;
});

socket.on("updateGame",(data)=>{
  gameData = data;
  updateUI();
});

// ---------- Card logic ----------
const randomPacks = [
  {q:"Most sus fruit?", a:"Banana", f1:"Potato", f2:"Cucumber"},
  {q:"Who invented lying?", a:"Your friend", f1:"Newton", f2:"Elon Musk"},
  {q:"Most likely to say 'Trust me bro'?", a:"Imposter", f1:"Cat", f2:"Politician"}
];

function drawRandomCard(){
  const r = randomPacks[Math.floor(Math.random()*randomPacks.length)];
  document.getElementById("questionInput").value=r.q;
  document.getElementById("answerInput").value=r.a;
  document.getElementById("fake1").value=r.f1;
  document.getElementById("fake2").value=r.f2;
}

function prepareCard(){
  const q=document.getElementById("questionInput").value.trim();
  const correct=document.getElementById("answerInput").value.trim();
  const f1=document.getElementById("fake1").value.trim();
  const f2=document.getElementById("fake2").value.trim();
  if(!q||!correct||!f1||!f2) return alert("Fill all fields!");

  let options = [{text:correct,correct:true},{text:f1,correct:false},{text:f2,correct:false}].sort(()=>Math.random()-0.5);
  const letters = ["A","B","C"];
  options.forEach((opt,i)=>opt.letter=letters[i]);

  gameData.currentCard={question:q,options};
  gameData.state="question";
  gameData.guesserQueue = gameData.players.filter((p,i)=>i!==gameData.turnIndex%gameData.players.length);
  gameData.currentGuesserIndex=0;

  // Card flip
  const cardDiv = document.getElementById("cardFrontBack");
  cardDiv.classList.remove("flipped");
  setTimeout(()=>cardDiv.classList.add("flipped"),200);

  const optDiv = document.getElementById("options");
  optDiv.innerHTML="";
  options.forEach(opt=>{
    const btn = document.createElement("button");
    btn.innerText=`${opt.letter}: ${opt.text}`;
    btn.onclick=()=>handleGuess(opt.correct);
    optDiv.appendChild(btn);
    optDiv.appendChild(document.createElement("br"));
  });

  document.getElementById("questionText").innerText = q;
  const correctLetter = options.find(o=>o.correct).letter;
  alert(`(Carder sees) Correct answer: ${correctLetter}`);

  socket.emit("updateGameState", gameData);
}

// ---------- Guess Handling ----------
function handleGuess(isCorrect){
  const carderIndex = gameData.turnIndex%gameData.players.length;
  const carder = gameData.players[carderIndex];
  const guesser = gameData.guesserQueue[gameData.currentGuesserIndex];

  let result="";
  if(isCorrect){
    gameData.scores[guesser]+=1;
    result=`${guesser} guessed correctly!`;
  } else {
    gameData.scores[carder]+=1;
    result=`${guesser} guessed wrong! Point to ${carder}!`;
  }

  gameData.history.push({q:gameData.currentCard.question, carder, guesser, result});
  gameData.currentGuesserIndex++;

  if(gameData.currentGuesserIndex>=gameData.guesserQueue.length){
    gameData.turnIndex++; gameData.state="setup"; gameData.currentCard=null;
    gameData.guesserQueue=null; gameData.currentGuesserIndex=null;
    alert("Round over! Next carder starts.");
  } else { alert(result); }

  socket.emit("updateGameState", gameData);
  updateUI();
}

// ---------- UI ----------
function updateUI(){
  const carder = gameData.players[gameData.turnIndex%gameData.players.length];
  document.getElementById("turnInfo").innerText = gameData.state==="setup" ? `${carder}'s Turn - Create Card` : `${carder}'s Card`;

  document.getElementById("cardSetup").style.display = gameData.state==="setup" ? "block" : "none";
  document.getElementById("questionScreen").style.display = gameData.state==="question" ? "block" : "none";

  const scoreHtml = Object.entries(gameData.scores).map(([n,s])=>`${n}: ${s}`).join("<br>");
  document.getElementById("scores").innerHTML = scoreHtml;

  const historyDiv = document.getElementById("history");
  historyDiv.innerHTML="";
  gameData.history.slice(-10).forEach(h=>{
    const div=document.createElement("div");
    div.className="history-entry";
    div.innerHTML=`<b>${h.q}</b><br>Carder: ${h.carder}, Guesser: ${h.guesser}<br><i>${h.result}</i>`;
    historyDiv.appendChild(div);
  });
}

function returnToMenu(){
  document.getElementById("menu").style.display="block";
  document.getElementById("game").style.display="none";
}

</script>
</body>
</html>
